<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/IDEonline.css' %}">
    <title>IDE ONLINE</title>
</head>
<body>
    <header>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="inner-head">
                        <div class="inner-logo">
                            <img src="https://scontent-hkg1-2.xx.fbcdn.net/v/t1.15752-9/509617644_1412222906577794_4739279048360180404_n.png?_nc_cat=102&ccb=1-7&_nc_sid=9f807c&_nc_ohc=93bp-KCXyKIQ7kNvwGfnJZD&_nc_oc=AdkReJIhOEZUQUi038njdwsrihij8JneijTW7hbgvPYz_XS_gyfgXAO1zEfPFwZGZKOk6KxENOV5l8ezFkdMVruG&_nc_zt=23&_nc_ht=scontent-hkg1-2.xx&oh=03_Q7cD2gGUg1JEd2OLigqSAUc9v_NRJzkax7WaNG01NkhIyoARKA&oe=688410C3" alt="Logo">
                        </div>
                        <div class="inner-menu">
                            <ul>
                                <li>
                                    <a href="{% url 'authentication:student_homepage' %}">HOME</a>
                                </li>
                                <li>
                                    <a href="{% url 'ai:chatbot' %}">AI SUPPORTER</a>
                                </li>
                                <li>
                                    <a href="{% url 'mainapp:aboutUs' %}">ABOUT US</a>
                                </li>
                            </ul>
                        </div>
                        <div class="inner-log">
                            <ul>
                                <li>
                                    <a href="{% url 'mainapp:profile' %}">Profile</a>
                                </li>
                                <li>
                                    <a href="{% url 'authentication:signout' %}">Log out</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="hero-wrapper">
        <div class="container">
            <div class="hero">
                <img src="https://cdn-icons-png.flaticon.com/128/7909/7909930.png" alt="IDE Icon" style="width: 64px; height: 64px; box-shadow: 0 4px 16px rgba(25,118,210,0.08); border-radius: 16px; background: #fff;">
                <h1 class="ide-title">IDE ONLINE</h1>
            </div>
        </div>
    </section>

    <section class="ide-section">
        <div class="container">
            <div class="toolbar">
                <button><img src="https://i.postimg.cc/jjTRH5tz/folder-3.png" alt="Folder" />Upload File</button>     
                    <input type="file" id="fileInput" accept=".py" style="display:none;">  
                <button id="aiFeedbackBtn">
                <img src="https://cdn-icons-png.flaticon.com/128/1628/1628666.png" style="width: 20px;"> Get AI Feedback
            </button>
            </div>
            
            <div class="tab-bar" id="tabBar">
                <button id="addTabBtn" class="tab-add-btn">+</button>
            </div>
            
             <div class="editor-area">
                <div class="editor-wrapper">
                    <div class="line-numbers" id="lineNumbers">1</div>
                    <textarea id="codeArea" class="code-editor" placeholder="Write your code here..."></textarea>
                </div>
                <div class="editor-footer">
                    <span id="cursorPosition">Ln: 1, Col: 1</span>
                </div>
            </div>
            <div class="run-btn-wrapper">
                <button id="runCodeBtn" class="run-btn">
                    <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="run-icon" alt="Run"> Run
                </button>
            </div>
            <div id="loading" style="display:none; color:#dc3545; font-weight:bold; margin:10px 0;">
                <span class="spinner"></span> Processing...
            </div>
            <div class="output-area">
                <textarea id="outputArea" class="output" placeholder="Output..."></textarea>
            </div>
            <div id="aiFeedbackMessage" style="display: none; margin-top: 20px; padding: 16px; background: #f1f8ff; border-left: 5px solid #2196f3; border-radius: 6px; font-family: 'Segoe UI', sans-serif;">
                <strong style="color: #0d47a1;">üí° AI Feedback:</strong>
                <p id="aiFeedbackContent" style="margin-top: 8px; color: #333;"></p>
            </div>

            <a href="{% url 'authentication:student_homepage' %}">
                <div class="back-btn-wrapper">
                    <button class="back-btn">BACK</button>
                </div>
            </a>
        </div>
    </section>           
        
    <footer class="footer">
        <div class="container">
            <div class="inner-content">
                <div class="row">
                    <div class="col-md-3 col-6">
                        <div class="inner-part">
                            <p class="inner-title">ABOUT US</p>
                            <p class="inner-desc">
                                AI-integrated programming learning system for Perl & Python.
                                Developed by CS466 group - Duy Tan University.
                            </p>
                            <div class="social-icons mt-3">
                                <a href="#"><i class="fab fa-facebook-f"></i></a>
                                <a href="#"><i class="fab fa-youtube"></i></a>
                                <a href="#"><i class="fab fa-github"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="inner-part">
                            <p class="inner-title">CONTACT</p>
                            <ul class="contact-list">
                                <li><i class="fas fa-map-marker-alt"></i> 128 Hoang Minh Thao</li>
                                <li><i class="fas fa-phone"></i> (024) 3869 4242</li>
                                <li><i class="fas fa-envelope"></i> support@perlpython.edu.vn</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="inner-part">
                            <p class="inner-title">RESOURCES</p>
                            <ul class="resource-list">
                                <li><a href="#"><i class="fas fa-book"></i> Study materials</a></li>
                                <li><a href="#"><i class="fas fa-code"></i> Sample exercises</a></li>
                                <li><a href="#"><i class="fas fa-video"></i> Lecture videos</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="inner-part">
                            <p class="inner-title">SUPPORT</p>
                            <ul class="support-list">
                                <li><a href="#"><i class="fas fa-question-circle"></i> FAQ</a></li>
                                <li><a href="#"><i class="fas fa-shield-alt"></i> Privacy Policy</a></li>
                                <li><a href="#"><i class="fas fa-file-alt"></i> Terms of Use</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="copyright text-center mt-4">
                    <p>¬© 2023 AI-Integrated Learning System. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const runBtn = document.querySelector(".run-btn");
    const folderBtn = document.querySelector('.toolbar button');
    const fileInput = document.getElementById('fileInput');
    const codeArea = document.getElementById("codeArea");
    const cursorPosition = document.getElementById("cursorPosition");
    const loadingDiv = document.getElementById('loading');
    const outputArea = document.querySelector(".output");
    const tabBar = document.getElementById('tabBar');
    const addTabBtn = document.getElementById('addTabBtn');
    const aiFeedbackBtn = document.getElementById("aiFeedbackBtn");
    const aiFeedbackBox = document.getElementById("aiFeedbackMessage");
    const aiFeedbackContent = document.getElementById("aiFeedbackContent");


    // Khi click v√†o n√∫t Folder, m·ªü h·ªôp tho·∫°i ch·ªçn file
    folderBtn.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
    });

    let tabs = [{name: "main.py", code: ""}];
    let currentTab = 0;
    function renderTabs() {
        tabBar.querySelectorAll('.tab-btn').forEach(e => e.remove());
        tabs.forEach((tab, idx) => {
            const btn = document.createElement('button');
            btn.className = 'tab-btn' + (idx === currentTab ? ' active' : '');
            // Th√™m icon file Python
            btn.innerHTML = `<img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg" class="tab-file-icon" alt="py"> ${tab.name}`;
            btn.onclick = () => switchTab(idx);
            if (tabs.length > 1) {
                const close = document.createElement('span');
                close.className = 'close-x';
                close.innerHTML = '&times;';
                close.onclick = (e) => {
                    e.stopPropagation();
                    closeTab(idx);
                };
                btn.appendChild(close);
            }
            tabBar.insertBefore(btn, addTabBtn);
        });
    }

    function switchTab(idx) {
        // L∆∞u code tab hi·ªán t·∫°i
        tabs[currentTab].code = codeArea.value;
        currentTab = idx;
        codeArea.value = tabs[currentTab].code;
        renderTabs();
        updateLineNumbers && updateLineNumbers();
        updateCursorPosition && updateCursorPosition();
    }

    function closeTab(idx) {
        if (tabs.length === 1) return;
        tabs.splice(idx, 1);
        if (currentTab >= idx) currentTab = Math.max(0, currentTab - 1);
        codeArea.value = tabs[currentTab].code;
        renderTabs();
        updateLineNumbers && updateLineNumbers();
        updateCursorPosition && updateCursorPosition();
    }

    addTabBtn.onclick = () => {
        tabs.push({name: `file${tabs.length+1}.py`, code: ""});
        switchTab(tabs.length - 1);
    };

    renderTabs();

    // Khi ch·ªçn file xong, ƒë·ªçc n·ªôi dung v√† b·ªè v√†o codeArea
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file && file.name.endsWith('.py')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                codeArea.value = e.target.result;
            };
            reader.readAsText(file);
        } else {
            alert('Please select a Python (.py) file!');
        }
    });
    runBtn.addEventListener("click", async () => {
        loadingDiv.style.display = "block"; // Hi·ªán loading
        outputArea.value = ""; // X√≥a output c≈© (n·∫øu mu·ªën)
        const program = codeArea.value;
        const payload = {
            script: program,
            language: "python3",
            versionIndex: "4"
        };

        try {
            const response = await fetch("/student/run_code/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            outputArea.value = data.output || "No output.";
        } catch (error) {
            outputArea.value = "Error running code.";
        }
        loadingDiv.style.display = "none"; // ·∫®n loading khi xong
    });

    document.addEventListener("DOMContentLoaded", function() {
        const codeArea = document.getElementById("codeArea");
        const lineNumbers = document.getElementById("lineNumbers");

        function updateLineNumbers() {
            const lines = codeArea.value.split('\n').length || 1;
            let html = '';
            for (let i = 1; i <= lines; i++) {
                html += i + '<br>';
            }
            lineNumbers.innerHTML = html;
        }

        codeArea.addEventListener("input", updateLineNumbers);
        codeArea.addEventListener("focus", updateLineNumbers);
        codeArea.addEventListener("scroll", function() {
            lineNumbers.scrollTop = codeArea.scrollTop;
        });
        updateLineNumbers();
    });

    aiFeedbackBtn.addEventListener("click", async () => {
        const userCode = codeArea.value.trim();
        if (!userCode) {
            aiFeedbackContent.textContent = "Please enter some code first.";
            aiFeedbackBox.style.display = "block";
            return;
        }

        aiFeedbackContent.textContent = "Analyzing your code with AI...";
        aiFeedbackBox.style.display = "block";

        try {
            const response = await fetch("/student/get_ai_feedback/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                body: JSON.stringify({ code: userCode })
            });

            const data = await response.json();
            aiFeedbackContent.innerHTML = (data.feedback || "No response.") 
    .replace(/\n/g, "<br>");
        } catch (error) {
            aiFeedbackContent.textContent = "Error while requesting feedback.";
        }
    });

    function updateCursorPosition() {
        const value = codeArea.value;
        const pos = codeArea.selectionStart;
        const lines = value.substr(0, pos).split("\n");
        const line = lines.length;
        const col = lines[lines.length - 1].length + 1;
        cursorPosition.textContent = `Ln: ${line}, Col: ${col}`;
    }

    codeArea.addEventListener("keyup", updateCursorPosition);
    codeArea.addEventListener("click", updateCursorPosition);
    codeArea.addEventListener("input", updateCursorPosition);
    codeArea.addEventListener("select", updateCursorPosition);

    // G·ªçi 1 l·∫ßn khi load
    updateCursorPosition();

    // L·∫•y CSRF token (b·∫Øt bu·ªôc n·∫øu d√πng Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>
</html>